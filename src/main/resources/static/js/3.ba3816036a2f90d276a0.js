webpackJsonp([3],{"2Q/H":function(e,t){},BO1k:function(e,t,s){e.exports={default:s("fxRn"),__esModule:!0}},GBg1:function(e,t){},fxRn:function(e,t,s){s("+tPU"),s("zQR9"),e.exports=s("g8Ux")},g8Ux:function(e,t,s){var i=s("77Pl"),a=s("3fs2");e.exports=s("FeBl").getIterator=function(e){var t=a(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return i(t.call(e))}},jlBr:function(e,t){},xUuw:function(e,t){},zfg2:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=s("Xxa5"),a=s.n(i),n=s("exGp"),o=s.n(n),r=s("Dd8w"),l=s.n(r),c=s("PJh5"),u=s.n(c),m=s("NYxO"),f={name:"ImDialog",props:{active:Boolean,push:Number,online:Boolean,me:Boolean,info:Object},computed:{recipientName:function(){return(this.info.last_message.isSentByMe?this.info.last_message.recipient.first_name:this.info.last_message.author.first_name)+" "+(this.info.last_message.isSentByMe?this.info.last_message.recipient.last_name:this.info.last_message.author.last_name)},recipientPhoto:function(){return this.info.last_message.isSentByMe?this.info.last_message.recipient.photo:this.info.last_message.author.photo},recipientId:function(){return this.info.last_message.isSentByMe?this.info.last_message.recipient.id:this.info.last_message.author.id},getRecipient:function(){return this.info.last_message.isSentByMe?this.info.last_message.recipient:this.info.last_message.author},statusText:function(){var e=this.info.last_message.isSentByMe?this.info.last_message.recipient:this.info.last_message.author;return u()().diff(u()(e.lastOnlineTime),"seconds")<=60?"Онлайн":"был в сети "+u()(e.lastOnlineTime).fromNow()}}},h={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"im-dialog",class:{active:e.active,push:e.push}},[s("router-link",{staticClass:"im-dailog__pic",attrs:{to:{name:"ProfileId",params:{id:e.recipientId}}}},[s("img",{attrs:{src:e.recipientPhoto,alt:e.recipientName}})]),s("div",{staticClass:"im-dialog__info"},[s("router-link",{staticClass:"im-dialog__name",attrs:{to:{name:"ProfileId",params:{id:e.recipientId}}}},[e._v(e._s(e.recipientName))]),s("span",{staticClass:"user-status",class:{online:e.online}},[e._v(e._s(e.statusText))])],1),s("div",{staticClass:"im-dialog__content"},[s("p",{staticClass:"im-dialog__last"},[e.me?s("span",{staticClass:"im-dialog__last-me"},[e._v("Вы:")]):e._e(),e._v(e._s(e.info.last_message.message_text))]),s("span",{staticClass:"im-dialog__time"},[e._v(e._s(e._f("moment")(e.info.last_message.time,"from")))])]),e.push>0?s("span",{staticClass:"im-dialog__push"},[e._v(e._s(e.push))]):e._e()],1)},staticRenderFns:[]};var d=s("VU/8")(f,h,!1,function(e){s("jlBr")},null,null).exports,_=s("BO1k"),g=s.n(_),p=(s("7+uW"),{name:"infinite-loading-item",props:{source:{type:Object,default:function(){return{}}}}}),v={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return e.source.stubDate?s("h5",{staticClass:"im-chat__message-title"},[e._v(e._s(e._f("moment")(e.source.date,"DD MMMM YYYY")))]):s("div",{staticClass:"im-chat__message-block",class:{me:e.source.isSentByMe}},[s("p",{staticClass:"im-chat__message-text"},[e._v(e._s(e.source.message_text))]),s("span",{staticClass:"im-chat__message-time"},[e._v(e._s(e._f("moment")(e.source.time,"YYYY-MM-DD hh:mm")))])])},staticRenderFns:[]};var y=s("VU/8")(p,v,!1,function(e){s("xUuw")},"data-v-1e46ed34",null).exports,x=(s("A7yg"),function(e){return{sid:"group-"+e,stubDate:!0,date:e}}),D={name:"ImChat",props:{info:Object,messages:Array,online:Boolean},data:function(){return{mes:"",itemComponent:y,isUserViewHistory:!1,fetching:!1}},mounted:function(){this.follow=!0},watch:{messages:function(){this.follow&&this.setVirtualListToBottom()}},computed:{recipientName:function(){return(this.info.last_message.isSentByMe?this.info.last_message.recipient.first_name:this.info.last_message.author.first_name)+" "+(this.info.last_message.isSentByMe?this.info.last_message.recipient.last_name:this.info.last_message.author.last_name)},recipientPhoto:function(){return this.info.last_message.isSentByMe?this.info.last_message.recipient.photo:this.info.last_message.author.photo},recipientId:function(){return this.info.last_message.isSentByMe?this.info.last_message.recipient.id:this.info.last_message.author.id},getRecipient:function(){return this.info.last_message.isSentByMe?this.info.last_message.recipient:this.info.last_message.author},statusText:function(){var e=this.info.last_message.isSentByMe?this.info.last_message.recipient:this.info.last_message.author;return u()().diff(u()(e.lastOnlineTime),"seconds")<=60?"Онлайн":"был в сети "+u()(e.lastOnlineTime).fromNow()},messagesGrouped:function(){var e=[],t=null,s=!0,i=!1,a=void 0;try{for(var n,o=g()(this.messages);!(s=(n=o.next()).done);s=!0){var r=n.value,l=u()(r.time).format("YYYY-MM-DD");l!==t&&(t=l,e.push(x(t))),e.push(r)}}catch(e){i=!0,a=e}finally{try{!s&&o.return&&o.return()}finally{if(i)throw a}}return e}},methods:l()({},Object(m.b)("profile/dialogs",["postMessage","loadOlderMessages"]),Object(m.c)("profile/dialogs",["isHistoryEndReached"]),{onSubmitMessage:function(){this.postMessage({id:this.info.id,message_text:this.mes}),this.mes=""},onScrollToTop:function(){var e=this;return o()(a.a.mark(function t(){var s;return a.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.$refs.vsl){t.next=8;break}if(e.isHistoryEndReached()){t.next=8;break}return s=e.messagesGrouped[0],e.fetching=!0,t.next=6,e.loadOlderMessages();case 6:e.setVirtualListToOffset(1),e.$nextTick(function(){var t=0,i=!0,a=!1,n=void 0;try{for(var o,r=g()(e.messagesGrouped);!(i=(o=r.next()).done);i=!0){var l=o.value;if(l.sid===s.sid)break;t+=e.$refs.vsl.getSize(l.sid)}}catch(e){a=!0,n=e}finally{try{!i&&r.return&&r.return()}finally{if(a)throw n}}e.setVirtualListToOffset(t),e.fetching=!1});case 8:case"end":return t.stop()}},t,e)}))()},onScroll:function(){this.follow=!1},onScrollToBottom:function(){this.follow=!0},setVirtualListToOffset:function(e){this.$refs.vsl&&this.$refs.vsl.scrollToOffset(e)},setVirtualListToBottom:function(){this.$refs.vsl&&this.$refs.vsl.scrollToBottom()}})},w={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"im-chat"},[s("div",{staticClass:"im-chat__user"},[s("router-link",{staticClass:"im-chat__user-pic",attrs:{to:{name:"ProfileId",params:{id:e.recipientId}}}},[s("img",{attrs:{src:e.recipientPhoto,alt:e.recipientName}})]),s("router-link",{staticClass:"im-chat__user-name",attrs:{to:{name:"ProfileId",params:{id:e.recipientId}}}},[e._v(e._s(e.recipientName))]),s("span",{staticClass:"user-status",class:{online:e.online}},[e._v(e._s(e.statusText))])],1),s("div",{staticClass:"im-chat__infitite_list_wrapper"},[s("virtual-list",{ref:"vsl",staticClass:"im-chat__infitite_list scroll-touch",attrs:{size:60,keeps:120,"data-key":"sid","data-sources":e.messagesGrouped,"data-component":e.itemComponent,"wrap-class":"im-chat__message","root-tag":"section"},on:{totop:e.onScrollToTop,"&scroll":function(t){return e.onScroll(t)},tobottom:e.onScrollToBottom}},[s("div",{directives:[{name:"show",rawName:"v-show",value:e.fetching,expression:"fetching"}],staticClass:"im-chat__loader",attrs:{slot:"header"},slot:"header"},[s("div",{directives:[{name:"show",rawName:"v-show",value:!e.isHistoryEndReached(),expression:"!isHistoryEndReached()"}],staticClass:"spinner"}),s("div",{directives:[{name:"show",rawName:"v-show",value:e.isHistoryEndReached(),expression:"isHistoryEndReached()"}],staticClass:"finished"},[e._v("Больше сообщений нет")])])])],1),s("form",{staticClass:"im-chat__enter",attrs:{action:"#"},on:{submit:function(t){return t.preventDefault(),e.onSubmitMessage(t)}}},[s("input",{directives:[{name:"model",rawName:"v-model",value:e.mes,expression:"mes"}],staticClass:"im-chat__enter-input",attrs:{type:"text",placeholder:"Ваше сообщение..."},domProps:{value:e.mes},on:{input:function(t){t.target.composing||(e.mes=t.target.value)}}})])])},staticRenderFns:[]};var B={name:"Im",components:{ImDialog:d,ImChat:s("VU/8")(D,w,!1,function(e){s("2Q/H")},null,null).exports},computed:l()({},Object(m.c)("profile/dialogs",["messages","activeDialog","dialogs"])),methods:l()({},Object(m.b)("profile/dialogs",["loadFreshMessages","switchDialog","closeDialog","createDialogWithUser","apiLoadAllDialogs"]),{countPush:function(e){return e>0?e:null},checkOnlineUser:function(e){return u()().diff(u()(e),"seconds")<=60},clickOnDialog:function(e){this.$router.push({name:"Im",query:{activeDialog:e}})},selectDialogByRoute:function(e,t){var s=this;return o()(a.a.mark(function i(){return a.a.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(!e.query.activeDialog){s.next=4;break}t.switchDialog(e.query.activeDialog),s.next=16;break;case 4:if(!e.query.userId){s.next=8;break}t.createDialogWithUser(e.query.userId),s.next=16;break;case 8:if(!(t.dialogs.length>0)){s.next=12;break}t.$router.push({name:"Im",query:{activeDialog:t.dialogs[0].id}}),s.next=16;break;case 12:return s.next=14,t.apiLoadAllDialogs();case 14:t.dialogs.length>0&&t.$router.push({name:"Im",query:{activeDialog:t.dialogs[0].id}}),console.log("No dialogs at all");case 16:case"end":return s.stop()}},i,s)}))()}}),beforeRouteEnter:function(e,t,s){var i,n=this;s((i=o()(a.a.mark(function t(s){return a.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:s.selectDialogByRoute(e,s);case 1:case"end":return t.stop()}},t,n)})),function(e){return i.apply(this,arguments)}))},beforeRouteUpdate:function(e,t,s){this.selectDialogByRoute(e,this),s()},beforeDestroy:function(){this.closeDialog()}},C={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"im"},[s("div",{staticClass:"im__dialogs"},e._l(e.dialogs,function(t){return s("im-dialog",{key:t.id,attrs:{info:t,push:e.countPush(t.unread_count),me:t.last_message.isSentByMe,active:e.activeDialog&&t.id===e.activeDialog.id,online:e.checkOnlineUser(t.last_message.recipient.last_online_time)},nativeOn:{click:function(s){return e.clickOnDialog(t.id)}}})}),1),e.activeDialog?s("div",{staticClass:"im__chat"},[s("im-chat",{attrs:{info:e.activeDialog,messages:e.messages,online:e.checkOnlineUser(e.activeDialog.last_message.recipient.last_online_time)}})],1):e._e()])},staticRenderFns:[]};var b=s("VU/8")(B,C,!1,function(e){s("GBg1")},null,null);t.default=b.exports}});
//# sourceMappingURL=3.ba3816036a2f90d276a0.js.map